<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ”¯å‡ºç®¡ç†</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: #F7F8FA;
      color: #1F2D3D;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== æ‰‹æœºå®¹å™¨ ===== */
    .mobile-container {
      max-width: 430px;
      width: 100%;
      margin: 0 auto;
      min-height: 100vh;
      background: #F7F8FA;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* ===== é¡¶éƒ¨å¯¼èˆª ===== */
    .nav-bar {
      background: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 0 rgba(0,0,0,0.05);
    }

    .nav-left, .nav-right {
      width: 40px;
      display: flex;
      align-items: center;
    }

    .back-btn {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
    }

    .nav-title {
      flex: 1;
      text-align: center;
      font-size: 17px;
      font-weight: 600;
      color: #1F2D3D;
    }

    /* ===== èŠå¤©åŒºåŸŸ ===== */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 16px;
    }

    /* ===== æ¶ˆæ¯æ ·å¼ ===== */
    .message {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      animation: slideIn 0.3s ease-out;
    }

    .message.user { flex-direction: row-reverse; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .avatar.ai {
      background: linear-gradient(135deg, #EB3223, #CC0000);
      color: white;
    }

    .avatar.user {
      background: #EDEFF2;
      color: #1F2D3D;
    }

    .message-content { flex: 1; max-width: calc(100% - 50px); }

    .message-text {
      font-size: 15px;
      line-height: 1.6;
      color: #1F2D3D;
      margin-bottom: 12px;
    }

    /* ===== å¿«æ·å›å¤æŒ‰é’® ===== */
    .quick-replies {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .quick-btn {
      padding: 10px 16px;
      background: white;
      border: 1px solid #EDEFF2;
      border-radius: 20px;
      font-size: 14px;
      color: #1F2D3D;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-btn:hover { border-color: #EB3223; color: #EB3223; }

    .quick-btn.primary {
      background: #EB3223;
      color: white;
      border-color: #EB3223;
    }

    .quick-btn.primary:hover { background: #CC0000; }

    /* ===== è¡¨å•å¡ç‰‡ ===== */
    .form-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .form-title {
      font-size: 16px;
      font-weight: 600;
      color: #1F2D3D;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #EDEFF2;
    }

    .section-header {
      font-size: 15px;
      font-weight: 600;
      color: #1F2D3D;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #EB3223;
    }

    /* ===== è¡¨å•å…ƒç´  ===== */
    .form-group { margin-bottom: 16px; }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #1F2D3D;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #EDEFF2;
      border-radius: 8px;
      font-size: 15px;
      color: #1F2D3D;
      transition: all 0.2s;
    }

    .form-input:focus { outline: none; border-color: #EB3223; }
    .form-input::placeholder { color: #C8CDD4; }

    .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #EDEFF2;
      border-radius: 8px;
      font-size: 15px;
      color: #1F2D3D;
      background: white;
      cursor: pointer;
    }

    .form-select:focus { outline: none; border-color: #EB3223; }

    .divider { height: 1px; background: #EDEFF2; margin: 20px 0; }

    /* ===== è¯¦æƒ… ===== */
    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #F7F8FA;
    }
    .detail-item:last-child { border-bottom: none; }

    .detail-item.total {
      border-top: 2px solid #EDEFF2;
      margin-top: 8px;
      padding-top: 16px;
    }

    .detail-label { font-size: 14px; color: #8A8F99; }
    .detail-value { font-size: 16px; font-weight: 600; color: #1F2D3D; }
    .detail-value.expense { color: #EB3223; }

    /* ===== æ“ä½œæŒ‰é’® ===== */
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .action-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn.btn-secondary { background: #F7F8FA; color: #8A8F99; }
    .action-btn.btn-secondary:hover { background: #EDEFF2; color: #1F2D3D; }

    .action-btn.btn-primary { background: #EB3223; color: white; }
    .action-btn.btn-primary:hover { background: #CC0000; }

    /* ===== æ”¯å‡ºå¡ç‰‡ ===== */
    .expense-card {
      background: #F8F9FA;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #EDEFF2;
    }

    .expense-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .expense-card-title {
      font-size: 15px;
      font-weight: 600;
      color: #1F2D3D;
    }

    .expense-card-amount {
      font-size: 18px;
      font-weight: 600;
      color: #EB3223;
    }

    .expense-card-detail {
      font-size: 13px;
      color: #8A8F99;
      margin-bottom: 12px;
    }

    .expense-card-actions { display: flex; gap: 8px; }

    .expense-card-btn {
      flex: 1;
      padding: 8px;
      background: white;
      border: 1px solid #EDEFF2;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #8A8F99;
      cursor: pointer;
      transition: all 0.2s;
    }

    .expense-card-btn:hover { border-color: #EB3223; color: #EB3223; }
    .expense-card-btn.delete:hover { background: #FFF5F5; }

    /* ===== åº•éƒ¨è¾“å…¥ ===== */
    .input-bar {
      background: white;
      padding: 12px 16px;
      border-top: 1px solid #EDEFF2;
      display: flex;
      gap: 12px;
      align-items: flex-end;
      position: sticky;
      bottom: 0;
      z-index: 100;
    }

    .message-input {
      flex: 1;
      padding: 12px 16px;
      background: #F7F8FA;
      border: 1px solid transparent;
      border-radius: 24px;
      font-size: 15px;
      color: #1F2D3D;
      outline: none;
      transition: all 0.2s;
    }

    .message-input:focus { background: white; border-color: #EB3223; }
    .message-input::placeholder { color: #C8CDD4; }

    .send-btn {
      width: 44px;
      height: 44px;
      background: #EB3223;
      color: white;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .send-btn:hover { background: #CC0000; transform: scale(1.05); }

    .send-btn svg { width: 20px; height: 20px; }

    /* ===== æç¤ºæ–‡å­— ===== */
    .hint-text { font-size: 13px; color: #8A8F99; margin-top: 4px; }
  </style>
</head>

<body>
  <div class="mobile-container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="nav-bar">
      <div class="nav-left">
        <button class="back-btn" onclick="goBack()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
      </div>
      <div class="nav-title">æ”¯å‡ºç®¡ç†</div>
      <div class="nav-right"></div>
    </div>

    <!-- èŠå¤©åŒºåŸŸ -->
    <div class="chat-container" id="chatContainer"></div>

    <!-- åº•éƒ¨è¾“å…¥ -->
    <div class="input-bar">
      <input type="text" class="message-input" id="messageInput" placeholder="è¾“å…¥é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæ”¯å‡ºå¤šå°‘">
      <button class="send-btn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    // ===== æ•°æ® =====
    let fixedExpenses = [];
    let largeExpenses = [];
    let editingExpense = null;

    // ===== å·¥å…·ï¼šè½¬ä¹‰ç”¨æˆ·è¾“å…¥ï¼ˆé˜²æ­¢ç ´åDOMï¼‰=====
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // ===== æ ¼å¼åŒ–é‡‘é¢ =====
    function formatAmount(amount) {
      const n = Number(amount) || 0;
      return 'Rp ' + n.toLocaleString('id-ID');
    }

    // ===== åˆå§‹åŒ– =====
    function init() {
      // ä» localStorage åŠ è½½æ•°æ®
      const savedData = localStorage.getItem('expenseData');
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          fixedExpenses = Array.isArray(data.fixedExpenses) ? data.fixedExpenses : [];
          largeExpenses = Array.isArray(data.largeExpenses) ? data.largeExpenses : [];
        } catch (e) {
          fixedExpenses = [];
          largeExpenses = [];
        }
      }

      // ç›´æ¥æ˜¾ç¤ºæ”¯å‡ºæ˜ç»†
      showExpenseDetailsInitial();
    }

    // ===== è·³è½¬åˆ°å…¶ä»–åŠŸèƒ½ =====
    function jumpToFunction(type) {
      if (type === 'income') {
        window.location.href = 'income-management.html';
      } else if (type === 'bill') {
        window.location.href = 'add-bill.html';
      } else if (type === 'analysis') {
        window.location.href = 'ai-analysis.html';
      }
    }

    // ===== åˆå§‹æ˜¾ç¤ºæ”¯å‡ºæ˜ç»†ï¼ˆä¸å¸¦ç”¨æˆ·æ¶ˆæ¯ï¼‰=====
    function showExpenseDetailsInitial() {
      const fixedTotal = fixedExpenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
      const largeTotal = largeExpenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
      const total = fixedTotal + largeTotal;

      let html = `
        <div class="form-card">
          <div class="form-title">æœ¬æœˆæ”¯å‡ºæ˜ç»†</div>
          <div class="detail-item total">
            <div class="detail-label">æ”¯å‡ºæ€»é¢</div>
            <div class="detail-value expense">${formatAmount(total)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">å›ºå®šæ”¯å‡º</div>
            <div class="detail-value expense">${formatAmount(fixedTotal)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">å¤§é¢æ”¯å‡º</div>
            <div class="detail-value expense">${formatAmount(largeTotal)}</div>
          </div>
        </div>
      `;

      // å›ºå®šæ”¯å‡ºåˆ—è¡¨
      if (fixedExpenses.length > 0) {
        html += `
          <div class="divider"></div>
          <div class="section-header">
            å›ºå®šæ”¯å‡º
            <span style="font-size: 13px; font-weight: 400; color: #8A8F99; margin-left: 8px;">ï¼ˆæ¯æœˆä¼šè‡ªåŠ¨è®¡ç®—ï¼‰</span>
          </div>
        `;
        fixedExpenses.forEach((exp, index) => {
          html += `
            <div class="expense-card" data-type="fixed" data-index="${index}">
              <div class="expense-card-header">
                <div class="expense-card-title">${escapeHtml(exp.category || '')}</div>
                <div class="expense-card-amount">${formatAmount(exp.amount)}</div>
              </div>
              <div class="expense-card-detail">æ¶ˆè´¹æ—¥æœŸï¼š${escapeHtml(exp.date || '')}</div>
              <div class="expense-card-actions">
                <button class="expense-card-btn btn-edit" type="button">ä¿®æ”¹</button>
                <button class="expense-card-btn btn-delete delete" type="button">åˆ é™¤</button>
              </div>
            </div>
          `;
        });
      }

      // å¤§é¢æ”¯å‡ºåˆ—è¡¨
      if (largeExpenses.length > 0) {
        html += `
          <div class="divider"></div>
          <div class="section-header">å¤§é¢æ”¯å‡º</div>
        `;
        largeExpenses.forEach((exp, index) => {
          html += `
            <div class="expense-card" data-type="large" data-index="${index}">
              <div class="expense-card-header">
                <div class="expense-card-title">${escapeHtml(exp.category || '')}</div>
                <div class="expense-card-amount">${formatAmount(exp.amount)}</div>
              </div>
              <div class="expense-card-detail">æ¶ˆè´¹æ—¥æœŸï¼š${escapeHtml(exp.date || '')}</div>
              <div class="expense-card-actions">
                <button class="expense-card-btn btn-edit" type="button">ä¿®æ”¹</button>
                <button class="expense-card-btn btn-delete delete" type="button">åˆ é™¤</button>
              </div>
            </div>
          `;
        });
      }

      // å¿«æ·æŒ‰é’®
      html += `
        <div class="divider"></div>
        <div class="quick-replies" id="initialQuickBtns">
          <button class="quick-btn primary" id="btnAddFixed" type="button">+ æ–°å¢å›ºå®šæ”¯å‡º</button>
          <button class="quick-btn primary" id="btnAddLarge" type="button">+ æ–°å¢å¤§é¢æ”¯å‡º</button>
        </div>
      `;

      showAIMessage(html);

      // ç»‘å®šæŒ‰é’®äº‹ä»¶ï¼ˆç¡®ä¿DOMå·²æ¸²æŸ“ï¼‰
      setTimeout(() => {
        // å›ºå®šæ”¯å‡ºï¼šä¿®æ”¹/åˆ é™¤
        document.querySelectorAll('.expense-card[data-type="fixed"]').forEach(card => {
          const index = parseInt(card.getAttribute('data-index'), 10);
          const editBtn = card.querySelector('.btn-edit');
          const deleteBtn = card.querySelector('.btn-delete');
          if (editBtn) editBtn.addEventListener('click', () => editFixedExpense(index));
          if (deleteBtn) deleteBtn.addEventListener('click', () => deleteFixedExpense(index));
        });

        // å¤§é¢æ”¯å‡ºï¼šä¿®æ”¹/åˆ é™¤
        document.querySelectorAll('.expense-card[data-type="large"]').forEach(card => {
          const index = parseInt(card.getAttribute('data-index'), 10);
          const editBtn = card.querySelector('.btn-edit');
          const deleteBtn = card.querySelector('.btn-delete');
          if (editBtn) editBtn.addEventListener('click', () => editLargeExpense(index));
          if (deleteBtn) deleteBtn.addEventListener('click', () => deleteLargeExpense(index));
        });

        // å¿«æ·æŒ‰é’®
        const btnAddFixed = document.getElementById('btnAddFixed');
        const btnAddLarge = document.getElementById('btnAddLarge');
        if (btnAddFixed) btnAddFixed.addEventListener('click', addFixedExpense);
        if (btnAddLarge) btnAddLarge.addEventListener('click', addLargeExpense);
      }, 50);
    }

    // ===== æ˜¾ç¤ºæ”¯å‡ºæ˜ç»†ï¼ˆå¸¦ç”¨æˆ·æ¶ˆæ¯ï¼‰=====
    function showExpenseDetails() {
      showUserMessage('æŸ¥çœ‹æ”¯å‡ºæ˜ç»†');
      showExpenseDetailsInitial();
    }

    // ===== æ˜¾ç¤ºå›ºå®šæ”¯å‡º =====
    function showFixedExpenses() {
      showUserMessage('æŸ¥çœ‹å›ºå®šæ”¯å‡º');

      if (fixedExpenses.length === 0) {
        showAIMessage(
          'ä½ è¿˜æ²¡æœ‰è®¾ç½®å›ºå®šæ”¯å‡ºã€‚è®¾ç½®åï¼Œç³»ç»Ÿä¼šæ¯æœˆè‡ªåŠ¨å°†å›ºå®šæ”¯å‡ºè®¡å…¥ä½ çš„æ”¯å‡ºæ˜ç»†ã€‚',
          { buttons: [{ text: 'æ–°å¢å›ºå®šæ”¯å‡º', primary: true, action: () => addFixedExpense() }] }
        );
        return;
      }

      const totalFixed = fixedExpenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);

      let html = `
        <div class="form-card">
          <div class="form-title">å›ºå®šæ”¯å‡º</div>
          <div class="detail-item total">
            <div class="detail-label">å›ºå®šæ”¯å‡ºæ€»é¢</div>
            <div class="detail-value expense">${formatAmount(totalFixed)}</div>
          </div>
        </div>
        <div class="hint-text" style="margin-bottom: 12px;">ğŸ’¡ ç³»ç»Ÿä¼šæ¯æœˆè‡ªåŠ¨å°†å›ºå®šæ”¯å‡ºè®¡å…¥ä½ çš„æ”¯å‡ºæ˜ç»†</div>
      `;

      fixedExpenses.forEach((exp, index) => {
        html += `
          <div class="expense-card" data-type="fixed" data-index="${index}">
            <div class="expense-card-header">
              <div class="expense-card-title">${escapeHtml(exp.category || '')}</div>
              <div class="expense-card-amount">${formatAmount(exp.amount)}</div>
            </div>
            <div class="expense-card-detail">æ¶ˆè´¹æ—¥æœŸï¼š${escapeHtml(exp.date || '')}</div>
            <div class="expense-card-actions">
              <button class="expense-card-btn btn-edit" type="button">ä¿®æ”¹</button>
              <button class="expense-card-btn btn-delete delete" type="button">åˆ é™¤</button>
            </div>
          </div>
        `;
      });

      showAIMessage(html, {
        buttons: [{ text: 'æ–°å¢å›ºå®šæ”¯å‡º', primary: true, action: () => addFixedExpense() }]
      });

      setTimeout(() => {
        document.querySelectorAll('.expense-card[data-type="fixed"]').forEach(card => {
          const index = parseInt(card.getAttribute('data-index'), 10);
          const editBtn = card.querySelector('.btn-edit');
          const deleteBtn = card.querySelector('.btn-delete');
          if (editBtn) editBtn.addEventListener('click', () => editFixedExpense(index));
          if (deleteBtn) deleteBtn.addEventListener('click', () => deleteFixedExpense(index));
        });
      }, 50);
    }

    // ===== æ˜¾ç¤ºå¤§é¢æ”¯å‡º =====
    function showLargeExpenses() {
      showUserMessage('æŸ¥çœ‹å¤§é¢æ”¯å‡º');

      if (largeExpenses.length === 0) {
        showAIMessage(
          'ä½ è¿˜æ²¡æœ‰è®°å½•å¤§é¢æ”¯å‡ºã€‚',
          { buttons: [{ text: 'æ–°å¢å¤§é¢æ”¯å‡º', primary: true, action: () => addLargeExpense() }] }
        );
        return;
      }

      const totalLarge = largeExpenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);

      let html = `
        <div class="form-card">
          <div class="form-title">å¤§é¢æ”¯å‡º</div>
          <div class="detail-item total">
            <div class="detail-label">å¤§é¢æ”¯å‡ºæ€»é¢</div>
            <div class="detail-value expense">${formatAmount(totalLarge)}</div>
          </div>
        </div>
      `;

      largeExpenses.forEach((exp, index) => {
        html += `
          <div class="expense-card" data-type="large" data-index="${index}">
            <div class="expense-card-header">
              <div class="expense-card-title">${escapeHtml(exp.category || '')}</div>
              <div class="expense-card-amount">${formatAmount(exp.amount)}</div>
            </div>
            <div class="expense-card-detail">æ¶ˆè´¹æ—¥æœŸï¼š${escapeHtml(exp.date || '')}</div>
            <div class="expense-card-actions">
              <button class="expense-card-btn btn-edit" type="button">ä¿®æ”¹</button>
              <button class="expense-card-btn btn-delete delete" type="button">åˆ é™¤</button>
            </div>
          </div>
        `;
      });

      showAIMessage(html, {
        buttons: [{ text: 'æ–°å¢å¤§é¢æ”¯å‡º', primary: true, action: () => addLargeExpense() }]
      });

      setTimeout(() => {
        document.querySelectorAll('.expense-card[data-type="large"]').forEach(card => {
          const index = parseInt(card.getAttribute('data-index'), 10);
          const editBtn = card.querySelector('.btn-edit');
          const deleteBtn = card.querySelector('.btn-delete');
          if (editBtn) editBtn.addEventListener('click', () => editLargeExpense(index));
          if (deleteBtn) deleteBtn.addEventListener('click', () => deleteLargeExpense(index));
        });
      }, 50);
    }

    // ===== æ–°å¢å›ºå®šæ”¯å‡º =====
    function addFixedExpense() {
      const html = `
        <div class="form-card">
          <div class="form-title">æ–°å¢å›ºå®šæ”¯å‡º</div>
          <div class="hint-text" style="margin-bottom: 16px;">ğŸ’¡ è®¾ç½®åï¼Œç³»ç»Ÿä¼šæ¯æœˆè‡ªåŠ¨å°†å›ºå®šæ”¯å‡ºè®¡å…¥ä½ çš„æ”¯å‡ºæ˜ç»†</div>

          <div class="form-group">
            <label class="form-label">æ”¯å‡ºç±»åˆ«</label>
            <input type="text" class="form-input" id="categoryInput" placeholder="ä¾‹å¦‚ï¼šæˆ¿ç§Ÿã€æ°´ç”µè´¹">
          </div>

          <div class="form-group">
            <label class="form-label">é‡‘é¢ (Rp)</label>
            <input type="number" class="form-input" id="amountInput" placeholder="è¾“å…¥é‡‘é¢">
          </div>

          <div class="form-group">
            <label class="form-label">æ¶ˆè´¹æ—¥æœŸ</label>
            <input type="date" class="form-input" id="dateInput">
          </div>

          <div class="btn-group">
            <button class="action-btn btn-secondary" type="button" onclick="closeForm()">å–æ¶ˆ</button>
            <button class="action-btn btn-primary" type="button" onclick="confirmAddFixedExpense()">æ·»åŠ </button>
          </div>
        </div>
      `;

      showAIMessage(html);

      setTimeout(() => {
        const dateInput = document.getElementById('dateInput');
        if (dateInput) dateInput.valueAsDate = new Date();
      }, 50);
    }

    function confirmAddFixedExpense() {
      const category = (document.getElementById('categoryInput')?.value || '').trim();
      const amount = parseFloat(document.getElementById('amountInput')?.value || '0') || 0;
      const date = document.getElementById('dateInput')?.value || '';

      if (!category || amount <= 0 || !date) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }

      fixedExpenses.push({ category, amount, date });
      saveData();

      closeForm();
      showUserMessage(`æ·»åŠ å›ºå®šæ”¯å‡ºï¼š${category} ${formatAmount(amount)}`);
      showAIMessage(
        `âœ… å·²æˆåŠŸæ·»åŠ å›ºå®šæ”¯å‡ºï¼<br><br>ç±»åˆ«ï¼š${escapeHtml(category)}<br>é‡‘é¢ï¼š${formatAmount(amount)}<br>æ¶ˆè´¹æ—¥æœŸï¼š${escapeHtml(date)}<br><br>ğŸ’¡ ç³»ç»Ÿä¼šæ¯æœˆè‡ªåŠ¨å°†æ­¤æ”¯å‡ºè®¡å…¥ä½ çš„æ”¯å‡ºæ˜ç»†`,
        { buttons: [{ text: 'ç»§ç»­æ·»åŠ ', action: () => addFixedExpense() }] }
      );
    }

    // ===== ç¼–è¾‘å›ºå®šæ”¯å‡º =====
    function editFixedExpense(index) {
      editingExpense = { type: 'fixed', index };
      const exp = fixedExpenses[index];
      if (!exp) return;

      const html = `
        <div class="form-card">
          <div class="form-title">ä¿®æ”¹å›ºå®šæ”¯å‡º</div>
          <div class="hint-text" style="margin-bottom: 16px;">ğŸ’¡ ä¿®æ”¹åï¼Œç³»ç»Ÿä¼šæŒ‰æ–°è®¾ç½®æ¯æœˆè‡ªåŠ¨è®¡ç®—</div>

          <div class="form-group">
            <label class="form-label">æ”¯å‡ºç±»åˆ«</label>
            <input type="text" class="form-input" id="categoryInput" value="${escapeHtml(exp.category || '')}">
          </div>

          <div class="form-group">
            <label class="form-label">é‡‘é¢ (Rp)</label>
            <input type="number" class="form-input" id="amountInput" value="${Number(exp.amount) || 0}">
          </div>

          <div class="form-group">
            <label class="form-label">æ¶ˆè´¹æ—¥æœŸ</label>
            <input type="date" class="form-input" id="dateInput" value="${escapeHtml(exp.date || '')}">
          </div>

          <div class="btn-group">
            <button class="action-btn btn-secondary" type="button" onclick="closeForm()">å–æ¶ˆ</button>
            <button class="action-btn btn-primary" type="button" onclick="confirmEditFixedExpense()">ä¿å­˜</button>
          </div>
        </div>
      `;

      showAIMessage(html);
    }

    function confirmEditFixedExpense() {
      if (!editingExpense || editingExpense.type !== 'fixed') return;

      const category = (document.getElementById('categoryInput')?.value || '').trim();
      const amount = parseFloat(document.getElementById('amountInput')?.value || '0') || 0;
      const date = document.getElementById('dateInput')?.value || '';

      if (!category || amount <= 0 || !date) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }

      fixedExpenses[editingExpense.index] = { category, amount, date };
      saveData();
      editingExpense = null;

      closeForm();
      showUserMessage(`æ›´æ–°å›ºå®šæ”¯å‡ºï¼š${category}`);
      showAIMessage(
        `âœ… å·²æˆåŠŸæ›´æ–°å›ºå®šæ”¯å‡ºï¼<br><br>ç±»åˆ«ï¼š${escapeHtml(category)}<br>é‡‘é¢ï¼š${formatAmount(amount)}<br>æ¶ˆè´¹æ—¥æœŸï¼š${escapeHtml(date)}<br><br>ğŸ’¡ ç³»ç»Ÿä¼šæ¯æœˆæŒ‰æ–°è®¾ç½®è‡ªåŠ¨è®¡ç®—`
      );
    }

    // ===== åˆ é™¤å›ºå®šæ”¯å‡º =====
    function deleteFixedExpense(index) {
      const exp = fixedExpenses[index];
      if (!exp) return;

      if (!confirm(`ç¡®å®šè¦åˆ é™¤å›ºå®šæ”¯å‡º "${exp.category}" å—ï¼Ÿ`)) return;

      fixedExpenses.splice(index, 1);
      saveData();

      showUserMessage(`åˆ é™¤å›ºå®šæ”¯å‡ºï¼š${exp.category}`);
      setTimeout(() => {
        showAIMessage(`âœ… å·²åˆ é™¤å›ºå®šæ”¯å‡ºï¼š${escapeHtml(exp.category)}`);
      }, 200);

      setTimeout(() => showExpenseDetailsInitial(), 800);
    }

    // ===== æ–°å¢å¤§é¢æ”¯å‡º =====
    function addLargeExpense() {
      const html = `
        <div class="form-card">
          <div class="form-title">æ–°å¢å¤§é¢æ”¯å‡º</div>

          <div class="form-group">
            <label class="form-label">æ”¯å‡ºç±»åˆ«</label>
            <input type="text" class="form-input" id="categoryInput" placeholder="ä¾‹å¦‚ï¼šè´­ä¹°å®¶ç”µã€æ—…è¡Œ">
          </div>

          <div class="form-group">
            <label class="form-label">é‡‘é¢ (Rp)</label>
            <input type="number" class="form-input" id="amountInput" placeholder="è¾“å…¥é‡‘é¢">
          </div>

          <div class="form-group">
            <label class="form-label">æ¶ˆè´¹æ—¥æœŸ</label>
            <input type="date" class="form-input" id="dateInput">
          </div>

          <div class="btn-group">
            <button class="action-btn btn-secondary" type="button" onclick="closeForm()">å–æ¶ˆ</button>
            <button class="action-btn btn-primary" type="button" onclick="confirmAddLargeExpense()">æ·»åŠ </button>
          </div>
        </div>
      `;

      showAIMessage(html);

      setTimeout(() => {
        const dateInput = document.getElementById('dateInput');
        if (dateInput) dateInput.valueAsDate = new Date();
      }, 50);
    }

    function confirmAddLargeExpense() {
      const category = (document.getElementById('categoryInput')?.value || '').trim();
      const amount = parseFloat(document.getElementById('amountInput')?.value || '0') || 0;
      const date = document.getElementById('dateInput')?.value || '';

      if (!category || amount <= 0 || !date) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }

      largeExpenses.push({ category, amount, date });
      saveData();

      closeForm();
      showUserMessage(`æ·»åŠ å¤§é¢æ”¯å‡ºï¼š${category} ${formatAmount(amount)}`);
      showAIMessage(
        `âœ… å·²æˆåŠŸæ·»åŠ å¤§é¢æ”¯å‡ºï¼<br><br>ç±»åˆ«ï¼š${escapeHtml(category)}<br>é‡‘é¢ï¼š${formatAmount(amount)}<br>æ¶ˆè´¹æ—¥æœŸï¼š${escapeHtml(date)}`,
        { buttons: [{ text: 'ç»§ç»­æ·»åŠ ', action: () => addLargeExpense() }] }
      );
    }

    // ===== ç¼–è¾‘å¤§é¢æ”¯å‡º =====
    function editLargeExpense(index) {
      editingExpense = { type: 'large', index };
      const exp = largeExpenses[index];
      if (!exp) return;

      const html = `
        <div class="form-card">
          <div class="form-title">ä¿®æ”¹å¤§é¢æ”¯å‡º</div>

          <div class="form-group">
            <label class="form-label">æ”¯å‡ºç±»åˆ«</label>
            <input type="text" class="form-input" id="categoryInput" value="${escapeHtml(exp.category || '')}">
          </div>

          <div class="form-group">
            <label class="form-label">é‡‘é¢ (Rp)</label>
            <input type="number" class="form-input" id="amountInput" value="${Number(exp.amount) || 0}">
          </div>

          <div class="form-group">
            <label class="form-label">æ¶ˆè´¹æ—¥æœŸ</label>
            <input type="date" class="form-input" id="dateInput" value="${escapeHtml(exp.date || '')}">
          </div>

          <div class="btn-group">
            <button class="action-btn btn-secondary" type="button" onclick="closeForm()">å–æ¶ˆ</button>
            <button class="action-btn btn-primary" type="button" onclick="confirmEditLargeExpense()">ä¿å­˜</button>
          </div>
        </div>
      `;

      showAIMessage(html);
    }

    function confirmEditLargeExpense() {
      if (!editingExpense || editingExpense.type !== 'large') return;

      const category = (document.getElementById('categoryInput')?.value || '').trim();
      const amount = parseFloat(document.getElementById('amountInput')?.value || '0') || 0;
      const date = document.getElementById('dateInput')?.value || '';

      if (!category || amount <= 0 || !date) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }

      largeExpenses[editingExpense.index] = { category, amount, date };
      saveData();
      editingExpense = null;

      closeForm();
      showUserMessage(`æ›´æ–°å¤§é¢æ”¯å‡ºï¼š${category}`);
      showAIMessage(`âœ… å·²æˆåŠŸæ›´æ–°å¤§é¢æ”¯å‡ºï¼<br><br>ç±»åˆ«ï¼š${escapeHtml(category)}<br>é‡‘é¢ï¼š${formatAmount(amount)}<br>æ¶ˆè´¹æ—¥æœŸï¼š${escapeHtml(date)}`);
    }

    // ===== åˆ é™¤å¤§é¢æ”¯å‡º =====
    function deleteLargeExpense(index) {
      const exp = largeExpenses[index];
      if (!exp) return;

      if (!confirm(`ç¡®å®šè¦åˆ é™¤å¤§é¢æ”¯å‡º "${exp.category}" å—ï¼Ÿ`)) return;

      largeExpenses.splice(index, 1);
      saveData();

      showUserMessage(`åˆ é™¤å¤§é¢æ”¯å‡ºï¼š${exp.category}`);
      setTimeout(() => {
        showAIMessage(`âœ… å·²åˆ é™¤å¤§é¢æ”¯å‡ºï¼š${escapeHtml(exp.category)}`);
      }, 200);

      setTimeout(() => showExpenseDetailsInitial(), 800);
    }

    // ===== å…³é—­è¡¨å•ï¼ˆç§»é™¤æœ€åä¸€æ¡AIæ¶ˆæ¯ï¼‰=====
    function closeForm() {
      const chatContainer = document.getElementById('chatContainer');
      const lastMessage = chatContainer.querySelector('.message:last-child');
      if (lastMessage && lastMessage.classList.contains('ai')) {
        lastMessage.remove();
      }
    }

    // ===== æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ =====
    function showUserMessage(text) {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message user';
      messageDiv.innerHTML = `
        <div class="avatar user">æˆ‘</div>
        <div class="message-content">
          <div class="message-text">${escapeHtml(text)}</div>
        </div>
      `;
      chatContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    // ===== æ˜¾ç¤ºAIæ¶ˆæ¯ï¼ˆå¯é€‰å¸¦æŒ‰é’®ï¼‰=====
    function showAIMessage(html, options = {}) {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ai';

      let content = `
        <div class="avatar ai">AI</div>
        <div class="message-content">
          <div class="message-text">${html}</div>
      `;

      if (options.buttons && Array.isArray(options.buttons) && options.buttons.length > 0) {
        content += `<div class="quick-replies">`;
        options.buttons.forEach(btn => {
          const btnClass = btn.primary ? 'quick-btn primary' : 'quick-btn';
          content += `<button class="${btnClass}" type="button">${escapeHtml(btn.text)}</button>`;
        });
        content += `</div>`;
      }

      content += `</div>`;
      messageDiv.innerHTML = content;

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      if (options.buttons && Array.isArray(options.buttons) && options.buttons.length > 0) {
        const buttons = messageDiv.querySelectorAll('.quick-btn');
        buttons.forEach((el, idx) => {
          const cfg = options.buttons[idx];
          if (cfg && typeof cfg.action === 'function') {
            el.addEventListener('click', cfg.action);
          }
        });
      }

      chatContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    // ===== å‘é€æ¶ˆæ¯ =====
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = (input?.value || '').trim();
      if (!message) return;

      showUserMessage(message);
      input.value = '';

      setTimeout(() => processUserMessage(message), 250);
    }

    // ===== å¤„ç†ç”¨æˆ·æ¶ˆæ¯ =====
    function processUserMessage(message) {
      const lowerMessage = message.toLowerCase();

      if (lowerMessage.includes('æ”¯å‡º') && (lowerMessage.includes('å¤šå°‘') || lowerMessage.includes('æ€»è®¡') || lowerMessage.includes('æ€»é¢') || lowerMessage.includes('æ€»'))) {
        showExpenseDetails();
      } else if (lowerMessage.includes('å›ºå®š') && lowerMessage.includes('æ”¯å‡º')) {
        showFixedExpenses();
      } else if ((lowerMessage.includes('å¤§é¢') || lowerMessage.includes('å¤§ç¬”')) && lowerMessage.includes('æ”¯å‡º')) {
        showLargeExpenses();
      } else if (lowerMessage.includes('ç»“ä½™')) {
        showUserMessage('æŸ¥çœ‹ç»“ä½™');
        showAIMessage('ç»“ä½™æ˜¯æŒ‡æ”¶å…¥å‡å»æ”¯å‡ºåçš„å‰©ä½™é‡‘é¢ã€‚è¯·åœ¨â€œæ”¶å…¥ç®¡ç†â€ä¸­æŸ¥çœ‹ä½ çš„ç»“ä½™æƒ…å†µã€‚');
      } else if (lowerMessage.includes('å¸®åŠ©') || lowerMessage.includes('æ€ä¹ˆ') || lowerMessage.includes('å¦‚ä½•')) {
        showAIMessage(
          `æˆ‘å¯ä»¥å¸®ä½ ç®¡ç†æ”¯å‡ºï¼ä½ å¯ä»¥é—®æˆ‘æˆ–ç‚¹å‡»æŒ‰é’®ï¼š<br><br>
           â€¢ â€œæ”¯å‡ºå¤šå°‘â€ - æŸ¥çœ‹æ”¯å‡ºæ€»é¢<br>
           â€¢ â€œå›ºå®šæ”¯å‡ºâ€ - æŸ¥çœ‹å›ºå®šæ”¯å‡ºæ˜ç»†<br>
           â€¢ â€œå¤§é¢æ”¯å‡ºâ€ - æŸ¥çœ‹å¤§é¢æ”¯å‡ºæ˜ç»†`,
          {
            buttons: [
              { text: 'æŸ¥çœ‹æ”¯å‡ºæ˜ç»†', primary: true, action: () => showExpenseDetails() },
              { text: 'å›ºå®šæ”¯å‡º', action: () => showFixedExpenses() },
              { text: 'å¤§é¢æ”¯å‡º', action: () => showLargeExpenses() }
            ]
          }
        );
      } else {
        showAIMessage(
          `æˆ‘æ”¶åˆ°äº†ä½ çš„æ¶ˆæ¯ï¼ä½ å¯ä»¥é—®æˆ‘å…³äºæ”¯å‡ºçš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæ”¯å‡ºå¤šå°‘ï¼Ÿå›ºå®šæ”¯å‡ºï¼Ÿå¤§é¢æ”¯å‡ºï¼Ÿ`,
          {
            buttons: [
              { text: 'æŸ¥çœ‹æ”¯å‡ºæ˜ç»†', primary: true, action: () => showExpenseDetails() },
              { text: 'å›ºå®šæ”¯å‡º', action: () => showFixedExpenses() },
              { text: 'å¤§é¢æ”¯å‡º', action: () => showLargeExpenses() }
            ]
          }
        );
      }
    }

    // ===== ä¿å­˜æ•°æ® =====
    function saveData() {
      const data = { fixedExpenses, largeExpenses };
      localStorage.setItem('expenseData', JSON.stringify(data));
    }

    // ===== æ»šåŠ¨åˆ°åº•éƒ¨ =====
    function scrollToBottom() {
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ===== å›åˆ°é¦–é¡µ =====
    function goBack() {
      localStorage.setItem('expenseStepCompleted', 'true');
      window.location.href = 'index-new.html';
    }

    // ===== å›è½¦å‘é€ =====
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendMessage();
    });

    // ===== åˆå§‹åŒ–è¿è¡Œ =====
    init();

    // ===== æŒ‚è½½åˆ° windowï¼ˆä»¥ä¾¿HTML onclickä½¿ç”¨ï¼‰=====
    window.showExpenseDetails = showExpenseDetails;
    window.showExpenseDetailsInitial = showExpenseDetailsInitial;
    window.showFixedExpenses = showFixedExpenses;
    window.showLargeExpenses = showLargeExpenses;
    window.addFixedExpense = addFixedExpense;
    window.confirmAddFixedExpense = confirmAddFixedExpense;
    window.editFixedExpense = editFixedExpense;
    window.confirmEditFixedExpense = confirmEditFixedExpense;
    window.deleteFixedExpense = deleteFixedExpense;
    window.addLargeExpense = addLargeExpense;
    window.confirmAddLargeExpense = confirmAddLargeExpense;
    window.editLargeExpense = editLargeExpense;
    window.confirmEditLargeExpense = confirmEditLargeExpense;
    window.deleteLargeExpense = deleteLargeExpense;
    window.closeForm = closeForm;
  </script>
</body>
</html>

