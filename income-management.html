<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ”¶å…¥ç®¡ç†</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: #F7F8FA;
      color: #1F2D3D;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* æ‰‹æœºå®¹å™¨ */
    .mobile-container {
      max-width: 430px;
      width: 100%;
      margin: 0 auto;
      min-height: 100vh;
      background: #F7F8FA;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* é¡¶éƒ¨å¯¼èˆª */
    .nav-bar {
      background: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 0 rgba(0,0,0,0.05);
    }

    .nav-left, .nav-right {
      width: 40px;
      display: flex;
      align-items: center;
    }

    .back-btn {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
    }

    .nav-title {
      flex: 1;
      text-align: center;
      font-size: 17px;
      font-weight: 600;
      color: #1F2D3D;
    }

    /* èŠå¤©åŒºåŸŸ */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 16px;
    }

    /* æ¶ˆæ¯æ ·å¼ */
    .message {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      animation: slideIn 0.3s ease-out;
    }

    .message.user { flex-direction: row-reverse; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .avatar.ai {
      background: linear-gradient(135deg, #EB3223, #CC0000);
      color: white;
    }

    .avatar.user {
      background: #EDEFF2;
      color: #1F2D3D;
    }

    .message-content { flex: 1; max-width: calc(100% - 50px); }

    .message-text {
      font-size: 15px;
      line-height: 1.6;
      color: #1F2D3D;
      margin-bottom: 12px;
    }

    /* å¿«æ·å›å¤æŒ‰é’® */
    .quick-replies { display: flex; flex-wrap: wrap; gap: 8px; }
    .quick-btn {
      padding: 10px 16px;
      background: white;
      border: 1px solid #EDEFF2;
      border-radius: 20px;
      font-size: 14px;
      color: #1F2D3D;
      cursor: pointer;
      transition: all 0.2s;
    }
    .quick-btn:hover { border-color: #EB3223; color: #EB3223; }
    .quick-btn.primary { background: #EB3223; color: white; border-color: #EB3223; }
    .quick-btn.primary:hover { background: #CC0000; }

    /* è¡¨å•å¡ç‰‡ */
    .form-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .form-title {
      font-size: 16px;
      font-weight: 600;
      color: #1F2D3D;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #EDEFF2;
    }

    .section-header {
      font-size: 15px;
      font-weight: 600;
      color: #1F2D3D;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #EB3223;
    }

    /* è¡¨å•å…ƒç´  */
    .form-group { margin-bottom: 16px; }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #1F2D3D;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #EDEFF2;
      border-radius: 8px;
      font-size: 15px;
      color: #1F2D3D;
      transition: all 0.2s;
    }

    .form-input:focus { outline: none; border-color: #EB3223; }
    .form-input::placeholder { color: #C8CDD4; }

    .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #EDEFF2;
      border-radius: 8px;
      font-size: 15px;
      color: #1F2D3D;
      background: white;
      cursor: pointer;
    }

    .form-select:focus { outline: none; border-color: #EB3223; }

    .divider { height: 1px; background: #EDEFF2; margin: 20px 0; }

    /* è¯¦æƒ… */
    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #F7F8FA;
    }
    .detail-item:last-child { border-bottom: none; }

    .detail-item.total {
      border-top: 2px solid #EDEFF2;
      margin-top: 8px;
      padding-top: 16px;
    }

    .detail-label { font-size: 14px; color: #8A8F99; }
    .detail-value { font-size: 16px; font-weight: 600; color: #1F2D3D; }
    .detail-value.income { color: #34B46A; }
    .detail-value.expense { color: #EB3223; }
    .detail-value-group { text-align: right; }
    .detail-sub { font-size: 12px; color: #8A8F99; margin-top: 2px; }

    /* æ“ä½œæŒ‰é’® */
    .btn-group { display: flex; gap: 12px; margin-top: 20px; }
    .action-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn.btn-secondary { background: #F7F8FA; color: #8A8F99; }
    .action-btn.btn-secondary:hover { background: #EDEFF2; color: #1F2D3D; }
    .action-btn.btn-primary { background: #EB3223; color: white; }
    .action-btn.btn-primary:hover { background: #CC0000; }

    /* æ”¶å…¥å¡ç‰‡ */
    .income-card {
      background: #F8F9FA;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #EDEFF2;
    }
    .income-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .income-card-title { font-size: 15px; font-weight: 600; color: #1F2D3D; }
    .income-card-amount { font-size: 18px; font-weight: 600; color: #34B46A; }
    .income-card-detail { font-size: 13px; color: #8A8F99; margin-bottom: 12px; }
    .income-card-actions { display: flex; gap: 8px; }
    .income-card-btn {
      flex: 1;
      padding: 8px;
      background: white;
      border: 1px solid #EDEFF2;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #8A8F99;
      cursor: pointer;
      transition: all 0.2s;
    }
    .income-card-btn:hover { border-color: #EB3223; color: #EB3223; }
    .income-card-btn.delete:hover { background: #FFF5F5; }

    /* åº•éƒ¨è¾“å…¥ */
    .input-bar {
      background: white;
      padding: 12px 16px;
      border-top: 1px solid #EDEFF2;
      display: flex;
      gap: 12px;
      align-items: flex-end;
      position: sticky;
      bottom: 0;
      z-index: 100;
    }

    .input-wrapper { flex: 1; display: flex; align-items: flex-end; }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #EDEFF2;
      border-radius: 24px;
      font-size: 15px;
      color: #1F2D3D;
      resize: none;
      max-height: 100px;
      min-height: 48px;
      font-family: inherit;
    }
    .chat-input:focus { outline: none; border-color: #EB3223; }
    .chat-input::placeholder { color: #C8CDD4; }

    .send-btn {
      width: 48px;
      height: 48px;
      border: none;
      border-radius: 50%;
      background: #EB3223;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .send-btn:hover:not(:disabled) { background: #CC0000; transform: scale(1.05); }
    .send-btn:disabled { background: #EDEFF2; cursor: not-allowed; }
    .send-btn svg { width: 20px; height: 20px; }
  </style>
</head>

<body>
  <div class="mobile-container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="nav-bar">
      <div class="nav-left">
        <button class="back-btn" onclick="goBack()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
      </div>
      <div class="nav-title">æ”¶å…¥ç®¡ç†</div>
      <div class="nav-right"></div>
    </header>

    <!-- èŠå¤©åŒºåŸŸ -->
    <div class="chat-container" id="chatContainer"></div>

    <!-- åº•éƒ¨è¾“å…¥ -->
    <div class="input-bar">
      <div class="input-wrapper">
        <textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯æˆ–é€‰æ‹©å¿«æ·æ“ä½œ..." rows="1"></textarea>
      </div>
      <button class="send-btn" id="sendBtn" disabled onclick="handleSend()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    // ===== æ•°æ®å­˜å‚¨ =====
    let balanceAmount = 1500000;
    let fixedIncomes = [
      { id: 1, source: 'å·¥èµ„', amount: 15000000, date: 'æ¯æœˆ25æ—¥' }
    ];
    let otherIncomes = [
      { id: 2, source: 'å‰¯ä¸šæ”¶å…¥', amount: 2500000, date: '2025-01-20' }
    ];

    // ===== æ ¼å¼åŒ–é‡‘é¢ =====
    function formatAmount(amount) {
      const n = Number(amount) || 0;
      return 'Rp ' + n.toLocaleString('id-ID');
    }

    // ===== è¿”å› =====
    function goBack() {
      localStorage.setItem('incomeStepCompleted', 'true');
      // è‹¥ä½ æ²¡æœ‰ index.htmlï¼Œå¯æ”¹æˆ history.back()
      window.location.href = 'index-new.html';
    }

    // ===== åˆå§‹åŒ– =====
    document.addEventListener('DOMContentLoaded', () => {
      initAssistant();
    });

    function initAssistant() {
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.innerHTML = '';

      setTimeout(() => {
        showIncomeOverview();
      }, 100);

      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('input', () => {
          document.getElementById('sendBtn').disabled = !chatInput.value.trim();
        });

        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
          }
        });
      }
    }

    // ===== æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ =====
    function showUserMessage(text) {
      const chatContainer = document.getElementById('chatContainer');
      const messageHTML = `
        <div class="message user">
          <div class="avatar user">æˆ‘</div>
          <div class="message-content">
            <div class="message-text">${escapeHtml(text)}</div>
          </div>
        </div>
      `;
      chatContainer.innerHTML += messageHTML;
      scrollToBottom();
    }

    // ===== æ˜¾ç¤ºAIæ¶ˆæ¯ =====
    function showAIMessage(text) {
      const chatContainer = document.getElementById('chatContainer');
      const messageHTML = `
        <div class="message ai">
          <div class="avatar ai">AI</div>
          <div class="message-content">
            <div class="message-text">${text}</div>
          </div>
        </div>
      `;
      chatContainer.innerHTML += messageHTML;
      scrollToBottom();
    }

    // é˜²æ­¢ç”¨æˆ·è¾“å…¥æŠŠ DOM æä¹±ï¼ˆåªå¯¹ç”¨æˆ·æ–‡æœ¬åšè½¬ä¹‰ï¼ŒAIå†…å®¹å…è®¸HTMLï¼‰
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // ===== æ»šåŠ¨åˆ°åº•éƒ¨ =====
    function scrollToBottom() {
      const chatContainer = document.getElementById('chatContainer');
      setTimeout(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }, 50);
    }

    // ===== æ˜¾ç¤ºæ”¶å…¥æ¦‚è§ˆ =====
    function showIncomeOverview() {
      const totalFixed = fixedIncomes.reduce((sum, inc) => sum + (Number(inc.amount) || 0), 0);
      const totalOther = otherIncomes.reduce((sum, inc) => sum + (Number(inc.amount) || 0), 0);
      const totalIncome = (Number(balanceAmount) || 0) + totalFixed + totalOther;

      const fixedIncomesHTML = fixedIncomes.map(inc => `
        <div class="income-card">
          <div class="income-card-header">
            <div class="income-card-title">${escapeHtml(inc.source)}</div>
            <div class="income-card-amount">${formatAmount(inc.amount)}</div>
          </div>
          <div class="income-card-detail">åˆ°è´¦æ—¥æœŸï¼š${escapeHtml(inc.date)}</div>
          <div class="income-card-actions">
            <button class="income-card-btn" onclick="editFixedIncome(${inc.id})">ä¿®æ”¹</button>
            <button class="income-card-btn delete" onclick="deleteFixedIncome(${inc.id})">åˆ é™¤</button>
          </div>
        </div>
      `).join('');

      const otherIncomesHTML = otherIncomes.map(inc => `
        <div class="income-card">
          <div class="income-card-header">
            <div class="income-card-title">${escapeHtml(inc.source)}</div>
            <div class="income-card-amount">${formatAmount(inc.amount)}</div>
          </div>
          <div class="income-card-detail">åˆ°è´¦æ—¥æœŸï¼š${escapeHtml(inc.date)}</div>
          <div class="income-card-actions">
            <button class="income-card-btn" onclick="editOtherIncome(${inc.id})">ä¿®æ”¹</button>
            <button class="income-card-btn delete" onclick="deleteOtherIncome(${inc.id})">åˆ é™¤</button>
          </div>
        </div>
      `).join('');

      const overviewHTML = `
        <div class="message ai">
          <div class="avatar ai">AI</div>
          <div class="message-content">
            <div class="message-text">
              ä»¥ä¸‹æ˜¯ä½ æœ¬æœˆçš„ <strong>æ”¶å…¥æ˜ç»†</strong>ï¼Œä½ å¯ä»¥ç›´æ¥ä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚
            </div>

            <div class="form-card">
              <div class="section-header">ğŸ’° æ”¶å…¥æ˜ç»†</div>

              <div class="form-group">
                <label class="form-label">ä¸Šæœˆç»“ä½™</label>
                <input type="text" class="form-input" id="balanceInput" value="${formatAmount(balanceAmount)}">
              </div>

              ${fixedIncomes.length > 0 ? `
                <div class="divider"></div>
                <div style="font-size: 15px; font-weight: 600; margin-bottom: 12px; color: #1F2D3D;">
                  å›ºå®šæ”¶å…¥
                  <span style="font-size: 12px; font-weight: 400; color: #8A8F99;">ï¼ˆæ¯æœˆä¼šè‡ªåŠ¨è®¡ç®—ï¼‰</span>
                </div>
                ${fixedIncomesHTML}
              ` : ''}

              ${otherIncomes.length > 0 ? `
                <div class="divider"></div>
                <div style="font-size: 15px; font-weight: 600; margin-bottom: 12px; color: #1F2D3D;">å…¶ä»–æ”¶å…¥</div>
                ${otherIncomesHTML}
              ` : ''}

              <div class="divider"></div>

              <div style="margin-bottom: 16px;">
                <div class="detail-item">
                  <div class="detail-label">ä¸Šæœˆç»“ä½™</div>
                  <div class="detail-value">${formatAmount(balanceAmount)}</div>
                </div>

                ${fixedIncomes.length > 0 ? `
                  <div class="detail-item">
                    <div class="detail-label">å›ºå®šæ”¶å…¥åˆè®¡</div>
                    <div class="detail-value income">${formatAmount(totalFixed)}</div>
                  </div>
                ` : ''}

                ${otherIncomes.length > 0 ? `
                  <div class="detail-item">
                    <div class="detail-label">å…¶ä»–æ”¶å…¥åˆè®¡</div>
                    <div class="detail-value income">${formatAmount(totalOther)}</div>
                  </div>
                ` : ''}

                <div class="detail-item total">
                  <div class="detail-label">æ€»æ”¶å…¥</div>
                  <div class="detail-value income">${formatAmount(totalIncome)}</div>
                </div>
              </div>

              <div class="btn-group">
                <button class="action-btn btn-secondary" onclick="goBack()">è¿”å›é¦–é¡µ</button>
                <button class="action-btn btn-primary" onclick="saveAllChanges()">ä¿å­˜ä¿®æ”¹</button>
              </div>
            </div>

            <div class="quick-replies" style="margin-top: 12px;">
              <button class="quick-btn" onclick="showAddFixedIncomeForm()">+ æ–°å¢å›ºå®šæ”¶å…¥</button>
              <button class="quick-btn" onclick="showAddOtherIncomeForm()">+ æ–°å¢å…¶ä»–æ”¶å…¥</button>
            </div>
          </div>
        </div>
      `;

      const chatContainer = document.getElementById('chatContainer');
      chatContainer.innerHTML = overviewHTML;

      // è®©ä½™é¢è¾“å…¥æ¡†å¤±ç„¦æ—¶è‡ªåŠ¨æ ¼å¼åŒ–
      const balanceInput = document.getElementById('balanceInput');
      if (balanceInput) {
        balanceInput.addEventListener('blur', () => {
          const amount = parseFloat(balanceInput.value.replace(/[^0-9.-]+/g, ''));
          balanceInput.value = formatAmount(isNaN(amount) ? 0 : amount);
        });
      }

      scrollToBottom();
    }

    // ===== ä¿å­˜æ‰€æœ‰ä¿®æ”¹ =====
    function saveAllChanges() {
      const balanceInput = document.getElementById('balanceInput');
      if (balanceInput) {
        const amount = parseFloat(balanceInput.value.replace(/[^0-9.-]+/g, ''));
        if (!isNaN(amount) && amount >= 0) {
          balanceAmount = amount;
        }
      }

      showUserMessage('ä¿å­˜ä¿®æ”¹');
      setTimeout(() => {
        showAIMessage('âœ… å·²æˆåŠŸä¿å­˜æ‰€æœ‰ä¿®æ”¹ï¼<br><br>ä½ çš„æ”¶å…¥æ˜ç»†å·²æ›´æ–°ï¼Œå¯ä»¥éšæ—¶è¿”å›æŸ¥çœ‹ã€‚');
      }, 500);

      setTimeout(() => {
        showIncomeOverview();
      }, 2000);
    }

    // ===== æ–°å¢å›ºå®šæ”¶å…¥ =====
    function showAddFixedIncomeForm() {
      showUserMessage('æ–°å¢å›ºå®šæ”¶å…¥');
      setTimeout(() => {
        const formHTML = `
          <div class="message ai">
            <div class="avatar ai">AI</div>
            <div class="message-content">
              <div class="message-text">
                å¥½çš„ï¼è¯·å¡«å†™å›ºå®šæ”¶å…¥ä¿¡æ¯ï¼š<br>
                <span style="font-size: 13px; color: #8A8F99;">ğŸ’¡ è®¾ç½®åï¼Œç³»ç»Ÿä¼šæ¯æœˆè‡ªåŠ¨å°†å›ºå®šæ”¶å…¥è®¡å…¥ä½ çš„æ”¶å…¥æ˜ç»†</span>
              </div>
              <div class="form-card">
                <div class="form-title">æ–°å¢å›ºå®šæ”¶å…¥</div>

                <div class="form-group">
                  <label class="form-label">æ”¶å…¥æ¥æº</label>
                  <input type="text" class="form-input" id="newFixedSource" placeholder="ä¾‹å¦‚ï¼šå·¥èµ„">
                </div>

                <div class="form-group">
                  <label class="form-label">é‡‘é¢</label>
                  <input type="text" class="form-input" id="newFixedAmount" placeholder="Rp 15,000,000">
                </div>

                <div class="form-group">
                  <label class="form-label">åˆ°è´¦æ—¥æœŸ</label>
                  <select class="form-select" id="newFixedDate">
                    <option value="æ¯æœˆ1æ—¥">æ¯æœˆ1æ—¥</option>
                    <option value="æ¯æœˆ5æ—¥">æ¯æœˆ5æ—¥</option>
                    <option value="æ¯æœˆ10æ—¥">æ¯æœˆ10æ—¥</option>
                    <option value="æ¯æœˆ15æ—¥">æ¯æœˆ15æ—¥</option>
                    <option value="æ¯æœˆ20æ—¥">æ¯æœˆ20æ—¥</option>
                    <option value="æ¯æœˆ25æ—¥" selected>æ¯æœˆ25æ—¥</option>
                    <option value="æ¯æœˆ30æ—¥">æ¯æœˆ30æ—¥</option>
                  </select>
                </div>

                <div class="btn-group">
                  <button class="action-btn btn-secondary" onclick="showIncomeOverview()">å–æ¶ˆ</button>
                  <button class="action-btn btn-primary" onclick="submitFixedIncome()">æ·»åŠ </button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.getElementById('chatContainer').innerHTML += formHTML;
        scrollToBottom();
      }, 300);
    }

    function submitFixedIncome() {
      const sourceEl = document.getElementById('newFixedSource');
      const amountEl = document.getElementById('newFixedAmount');
      const dateEl = document.getElementById('newFixedDate');

      const source = (sourceEl?.value || '').trim();
      const amountInput = (amountEl?.value || '').trim();
      const date = dateEl?.value || '';

      const amount = parseFloat(amountInput.replace(/[^0-9.-]+/g, ''));

      if (!source) { alert('è¯·è¾“å…¥æ”¶å…¥æ¥æº'); return; }
      if (isNaN(amount) || amount <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢'); return; }
      if (!date) { alert('è¯·é€‰æ‹©åˆ°è´¦æ—¥æœŸ'); return; }

      fixedIncomes.push({ id: Date.now(), source, amount, date });

      showUserMessage(`æ·»åŠ å›ºå®šæ”¶å…¥ï¼š${source} ${formatAmount(amount)}`);
      setTimeout(() => {
        showAIMessage(
          `âœ… å·²æˆåŠŸæ·»åŠ å›ºå®šæ”¶å…¥ï¼<br><br>
           æ¥æºï¼š${escapeHtml(source)}<br>
           é‡‘é¢ï¼š${formatAmount(amount)}<br>
           åˆ°è´¦æ—¥æœŸï¼š${escapeHtml(date)}<br><br>
           ğŸ’¡ ç³»ç»Ÿä¼šæ¯æœˆè‡ªåŠ¨å°†æ­¤æ”¶å…¥è®¡å…¥ä½ çš„æ”¶å…¥æ˜ç»†`
        );
      }, 500);

      setTimeout(() => {
        showIncomeOverview();
      }, 2000);
    }

    // ===== æ–°å¢å…¶ä»–æ”¶å…¥ =====
    function showAddOtherIncomeForm() {
      showUserMessage('æ–°å¢å…¶ä»–æ”¶å…¥');
      setTimeout(() => {
        const formHTML = `
          <div class="message ai">
            <div class="avatar ai">AI</div>
            <div class="message-content">
              <div class="message-text">å¥½çš„ï¼è¯·å¡«å†™å…¶ä»–æ”¶å…¥ä¿¡æ¯ï¼š</div>
              <div class="form-card">
                <div class="form-title">æ–°å¢å…¶ä»–æ”¶å…¥</div>

                <div class="form-group">
                  <label class="form-label">æ”¶å…¥æ¥æº</label>
                  <input type="text" class="form-input" id="newOtherSource" placeholder="ä¾‹å¦‚ï¼šå‰¯ä¸šæ”¶å…¥">
                </div>

                <div class="form-group">
                  <label class="form-label">é‡‘é¢</label>
                  <input type="text" class="form-input" id="newOtherAmount" placeholder="Rp 2,500,000">
                </div>

                <div class="form-group">
                  <label class="form-label">åˆ°è´¦æ—¥æœŸ</label>
                  <input type="date" class="form-input" id="newOtherDate">
                </div>

                <div class="btn-group">
                  <button class="action-btn btn-secondary" onclick="showIncomeOverview()">å–æ¶ˆ</button>
                  <button class="action-btn btn-primary" onclick="submitOtherIncome()">æ·»åŠ </button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.getElementById('chatContainer').innerHTML += formHTML;
        scrollToBottom();
      }, 300);
    }

    function submitOtherIncome() {
      const sourceEl = document.getElementById('newOtherSource');
      const amountEl = document.getElementById('newOtherAmount');
      const dateEl = document.getElementById('newOtherDate');

      const source = (sourceEl?.value || '').trim();
      const amountInput = (amountEl?.value || '').trim();
      const date = dateEl?.value || '';

      const amount = parseFloat(amountInput.replace(/[^0-9.-]+/g, ''));

      if (!source) { alert('è¯·è¾“å…¥æ”¶å…¥æ¥æº'); return; }
      if (isNaN(amount) || amount <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢'); return; }
      if (!date) { alert('è¯·é€‰æ‹©åˆ°è´¦æ—¥æœŸ'); return; }

      otherIncomes.push({ id: Date.now(), source, amount, date });

      showUserMessage(`æ·»åŠ å…¶ä»–æ”¶å…¥ï¼š${source} ${formatAmount(amount)}`);
      setTimeout(() => {
        showAIMessage(
          `âœ… å·²æˆåŠŸæ·»åŠ å…¶ä»–æ”¶å…¥ï¼<br><br>
           æ¥æºï¼š${escapeHtml(source)}<br>
           é‡‘é¢ï¼š${formatAmount(amount)}<br>
           åˆ°è´¦æ—¥æœŸï¼š${escapeHtml(date)}`
        );
      }, 500);

      setTimeout(() => {
        showIncomeOverview();
      }, 2000);
    }

    // ===== ç¼–è¾‘å›ºå®šæ”¶å…¥ =====
    function editFixedIncome(id) {
      const income = fixedIncomes.find(inc => inc.id === id);
      if (!income) return;

      showUserMessage(`ä¿®æ”¹å›ºå®šæ”¶å…¥ï¼š${income.source}`);
      setTimeout(() => {
        const formHTML = `
          <div class="message ai">
            <div class="avatar ai">AI</div>
            <div class="message-content">
              <div class="message-text">
                è¯·ä¿®æ”¹å›ºå®šæ”¶å…¥ä¿¡æ¯ï¼š<br>
                <span style="font-size: 13px; color: #8A8F99;">ğŸ’¡ ä¿®æ”¹åï¼Œç³»ç»Ÿä¼šæŒ‰æ–°è®¾ç½®æ¯æœˆè‡ªåŠ¨è®¡ç®—</span>
              </div>
              <div class="form-card">
                <div class="form-title">ä¿®æ”¹å›ºå®šæ”¶å…¥</div>

                <div class="form-group">
                  <label class="form-label">æ”¶å…¥æ¥æº</label>
                  <input type="text" class="form-input" id="editFixedSource" value="${escapeHtml(income.source)}">
                </div>

                <div class="form-group">
                  <label class="form-label">é‡‘é¢</label>
                  <input type="text" class="form-input" id="editFixedAmount" value="${formatAmount(income.amount)}">
                </div>

                <div class="form-group">
                  <label class="form-label">åˆ°è´¦æ—¥æœŸ</label>
                  <select class="form-select" id="editFixedDate">
                    ${renderMonthlyOptions(income.date)}
                  </select>
                </div>

                <div class="btn-group">
                  <button class="action-btn btn-secondary" onclick="showIncomeOverview()">å–æ¶ˆ</button>
                  <button class="action-btn btn-primary" onclick="updateFixedIncome(${id})">ä¿å­˜</button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.getElementById('chatContainer').innerHTML += formHTML;
        scrollToBottom();
      }, 300);
    }

    function renderMonthlyOptions(selected) {
      const days = [1,5,10,15,20,25,30];
      return days.map(d => {
        const v = `æ¯æœˆ${d}æ—¥`;
        const isSel = (v === selected) ? 'selected' : '';
        return `<option value="${v}" ${isSel}>${v}</option>`;
      }).join('');
    }

    function updateFixedIncome(id) {
      const source = (document.getElementById('editFixedSource')?.value || '').trim();
      const amountInput = (document.getElementById('editFixedAmount')?.value || '').trim();
      const date = document.getElementById('editFixedDate')?.value || '';

      const amount = parseFloat(amountInput.replace(/[^0-9.-]+/g, ''));

      if (!source) { alert('è¯·è¾“å…¥æ”¶å…¥æ¥æº'); return; }
      if (isNaN(amount) || amount <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢'); return; }
      if (!date) { alert('è¯·é€‰æ‹©åˆ°è´¦æ—¥æœŸ'); return; }

      const index = fixedIncomes.findIndex(inc => inc.id === id);
      if (index !== -1) fixedIncomes[index] = { id, source, amount, date };

      showUserMessage(`æ›´æ–°å›ºå®šæ”¶å…¥ï¼š${source}`);
      setTimeout(() => {
        showAIMessage(
          `âœ… å·²æˆåŠŸæ›´æ–°å›ºå®šæ”¶å…¥ï¼<br><br>
           æ¥æºï¼š${escapeHtml(source)}<br>
           é‡‘é¢ï¼š${formatAmount(amount)}<br>
           åˆ°è´¦æ—¥æœŸï¼š${escapeHtml(date)}<br><br>
           ğŸ’¡ ç³»ç»Ÿä¼šæ¯æœˆæŒ‰æ–°è®¾ç½®è‡ªåŠ¨è®¡ç®—`
        );
      }, 500);

      setTimeout(() => {
        showIncomeOverview();
      }, 2000);
    }

    // ===== ç¼–è¾‘å…¶ä»–æ”¶å…¥ =====
    function editOtherIncome(id) {
      const income = otherIncomes.find(inc => inc.id === id);
      if (!income) return;

      showUserMessage(`ä¿®æ”¹å…¶ä»–æ”¶å…¥ï¼š${income.source}`);
      setTimeout(() => {
        const formHTML = `
          <div class="message ai">
            <div class="avatar ai">AI</div>
            <div class="message-content">
              <div class="message-text">è¯·ä¿®æ”¹å…¶ä»–æ”¶å…¥ä¿¡æ¯ï¼š</div>
              <div class="form-card">
                <div class="form-title">ä¿®æ”¹å…¶ä»–æ”¶å…¥</div>

                <div class="form-group">
                  <label class="form-label">æ”¶å…¥æ¥æº</label>
                  <input type="text" class="form-input" id="editOtherSource" value="${escapeHtml(income.source)}">
                </div>

                <div class="form-group">
                  <label class="form-label">é‡‘é¢</label>
                  <input type="text" class="form-input" id="editOtherAmount" value="${formatAmount(income.amount)}">
                </div>

                <div class="form-group">
                  <label class="form-label">åˆ°è´¦æ—¥æœŸ</label>
                  <input type="date" class="form-input" id="editOtherDate" value="${escapeHtml(income.date)}">
                </div>

                <div class="btn-group">
                  <button class="action-btn btn-secondary" onclick="showIncomeOverview()">å–æ¶ˆ</button>
                  <button class="action-btn btn-primary" onclick="updateOtherIncome(${id})">ä¿å­˜</button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.getElementById('chatContainer').innerHTML += formHTML;
        scrollToBottom();
      }, 300);
    }

    function updateOtherIncome(id) {
      const source = (document.getElementById('editOtherSource')?.value || '').trim();
      const amountInput = (document.getElementById('editOtherAmount')?.value || '').trim();
      const date = document.getElementById('editOtherDate')?.value || '';

      const amount = parseFloat(amountInput.replace(/[^0-9.-]+/g, ''));

      if (!source) { alert('è¯·è¾“å…¥æ”¶å…¥æ¥æº'); return; }
      if (isNaN(amount) || amount <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢'); return; }
      if (!date) { alert('è¯·é€‰æ‹©åˆ°è´¦æ—¥æœŸ'); return; }

      const index = otherIncomes.findIndex(inc => inc.id === id);
      if (index !== -1) otherIncomes[index] = { id, source, amount, date };

      showUserMessage(`æ›´æ–°å…¶ä»–æ”¶å…¥ï¼š${source}`);
      setTimeout(() => {
        showAIMessage(
          `âœ… å·²æˆåŠŸæ›´æ–°å…¶ä»–æ”¶å…¥ï¼<br><br>
           æ¥æºï¼š${escapeHtml(source)}<br>
           é‡‘é¢ï¼š${formatAmount(amount)}<br>
           åˆ°è´¦æ—¥æœŸï¼š${escapeHtml(date)}`
        );
      }, 500);

      setTimeout(() => {
        showIncomeOverview();
      }, 2000);
    }

    // ===== åˆ é™¤å›ºå®šæ”¶å…¥ =====
    function deleteFixedIncome(id) {
      const income = fixedIncomes.find(inc => inc.id === id);
      if (!income) return;

      if (!confirm(`ç¡®å®šè¦åˆ é™¤å›ºå®šæ”¶å…¥ "${income.source}" å—ï¼Ÿ`)) return;

      fixedIncomes = fixedIncomes.filter(inc => inc.id !== id);

      showUserMessage(`åˆ é™¤å›ºå®šæ”¶å…¥ï¼š${income.source}`);
      setTimeout(() => {
        showAIMessage(
          `âœ… å·²æˆåŠŸåˆ é™¤å›ºå®šæ”¶å…¥ï¼<br><br>
           æ¥æºï¼š${escapeHtml(income.source)}<br>
           é‡‘é¢ï¼š${formatAmount(income.amount)}`
        );
      }, 500);

      setTimeout(() => {
        showIncomeOverview();
      }, 2000);
    }

    // ===== åˆ é™¤å…¶ä»–æ”¶å…¥ =====
    function deleteOtherIncome(id) {
      const income = otherIncomes.find(inc => inc.id === id);
      if (!income) return;

      if (!confirm(`ç¡®å®šè¦åˆ é™¤å…¶ä»–æ”¶å…¥ "${income.source}" å—ï¼Ÿ`)) return;

      otherIncomes = otherIncomes.filter(inc => inc.id !== id);

      showUserMessage(`åˆ é™¤å…¶ä»–æ”¶å…¥ï¼š${income.source}`);
      setTimeout(() => {
        showAIMessage(
          `âœ… å·²æˆåŠŸåˆ é™¤å…¶ä»–æ”¶å…¥ï¼<br><br>
           æ¥æºï¼š${escapeHtml(income.source)}<br>
           é‡‘é¢ï¼š${formatAmount(income.amount)}`
        );
      }, 500);

      setTimeout(() => {
        showIncomeOverview();
      }, 2000);
    }

    // ===== å¤„ç†ç”¨æˆ·å‘é€æ¶ˆæ¯ =====
    function handleSend() {
      const chatInput = document.getElementById('chatInput');
      const message = chatInput.value.trim();

      if (!message) return;

      showUserMessage(message);
      chatInput.value = '';
      document.getElementById('sendBtn').disabled = true;

      setTimeout(() => {
        processUserMessage(message);
      }, 400);
    }

    // ===== å¤„ç†ç”¨æˆ·æ¶ˆæ¯ï¼ˆæ™ºèƒ½å›å¤ï¼‰ =====
    function processUserMessage(message) {
      const lower = message.toLowerCase();

      // æ€»æ”¶å…¥
      if (lower.includes('æ”¶å…¥') && (lower.includes('å¤šå°‘') || lower.includes('æ€»è®¡') || lower.includes('æ€»å…±') || lower.includes('æ€»'))) {
        const totalFixed = fixedIncomes.reduce((sum, inc) => sum + (Number(inc.amount) || 0), 0);
        const totalOther = otherIncomes.reduce((sum, inc) => sum + (Number(inc.amount) || 0), 0);
        const totalIncome = (Number(balanceAmount) || 0) + totalFixed + totalOther;

        showAIMessage(
          `ä½ æœ¬æœˆçš„ <strong>æ€»æ”¶å…¥</strong> æ˜¯ï¼š${formatAmount(totalIncome)}<br><br>
           å…¶ä¸­ï¼š<br>
           â€¢ ä¸Šæœˆç»“ä½™ï¼š${formatAmount(balanceAmount)}<br>
           â€¢ å›ºå®šæ”¶å…¥ï¼š${formatAmount(totalFixed)}<br>
           â€¢ å…¶ä»–æ”¶å…¥ï¼š${formatAmount(totalOther)}`
        );
        return;
      }

      // å›ºå®šæ”¶å…¥
      if (lower.includes('å›ºå®š') && lower.includes('æ”¶å…¥')) {
        if (fixedIncomes.length === 0) {
          showAIMessage('ä½ è¿˜æ²¡æœ‰è®¾ç½®å›ºå®šæ”¶å…¥ã€‚å¯ä»¥ç‚¹å‡»ä¸‹æ–¹ â€œ+ æ–°å¢å›ºå®šæ”¶å…¥â€ æŒ‰é’®æ·»åŠ ã€‚<br><br>ğŸ’¡ è®¾ç½®åç³»ç»Ÿä¼šæ¯æœˆè‡ªåŠ¨è®¡å…¥ã€‚');
        } else {
          const totalFixed = fixedIncomes.reduce((sum, inc) => sum + (Number(inc.amount) || 0), 0);
          const details = fixedIncomes
            .map(inc => `â€¢ ${escapeHtml(inc.source)}ï¼š${formatAmount(inc.amount)}ï¼ˆ${escapeHtml(inc.date)}ï¼‰`)
            .join('<br>');
          showAIMessage(`ä½ æœ‰ <strong>${fixedIncomes.length}</strong> ç¬”å›ºå®šæ”¶å…¥ï¼Œæ€»è®¡ï¼š${formatAmount(totalFixed)}<br><br>${details}`);
        }
        return;
      }

      // å…¶ä»–æ”¶å…¥
      if (lower.includes('å…¶ä»–') && lower.includes('æ”¶å…¥')) {
        if (otherIncomes.length === 0) {
          showAIMessage('ä½ è¿˜æ²¡æœ‰æ·»åŠ å…¶ä»–æ”¶å…¥ã€‚å¯ä»¥ç‚¹å‡»ä¸‹æ–¹ â€œ+ æ–°å¢å…¶ä»–æ”¶å…¥â€ æŒ‰é’®æ·»åŠ ã€‚');
        } else {
          const totalOther = otherIncomes.reduce((sum, inc) => sum + (Number(inc.amount) || 0), 0);
          const details = otherIncomes
            .map(inc => `â€¢ ${escapeHtml(inc.source)}ï¼š${formatAmount(inc.amount)}ï¼ˆ${escapeHtml(inc.date)}ï¼‰`)
            .join('<br>');
          showAIMessage(`ä½ æœ‰ <strong>${otherIncomes.length}</strong> ç¬”å…¶ä»–æ”¶å…¥ï¼Œæ€»è®¡ï¼š${formatAmount(totalOther)}<br><br>${details}`);
        }
        return;
      }

      // ç»“ä½™
      if (lower.includes('ç»“ä½™') || lower.includes('å‰©ä½™')) {
        showAIMessage(`ä½ ä¸Šæœˆçš„ç»“ä½™æ˜¯ï¼š<strong>${formatAmount(balanceAmount)}</strong><br><br>å¯ä»¥åœ¨ä¸Šæ–¹è¾“å…¥æ¡†ä¸­ç›´æ¥ä¿®æ”¹è¿™ä¸ªé‡‘é¢ã€‚`);
        return;
      }

      // å¸®åŠ©
      if (lower.includes('å¸®åŠ©') || lower.includes('æ€ä¹ˆ') || lower.includes('å¦‚ä½•')) {
        showAIMessage(
          `æˆ‘å¯ä»¥å¸®ä½ ï¼š<br><br>
           â€¢ <strong>æŸ¥çœ‹æ”¶å…¥</strong>ï¼šé—®â€œæ”¶å…¥å¤šå°‘ / æ€»æ”¶å…¥â€<br>
           â€¢ <strong>æ·»åŠ æ”¶å…¥</strong>ï¼šç‚¹å‡»ä¸‹æ–¹å¿«æ·æŒ‰é’®<br>
           â€¢ <strong>ä¿®æ”¹æ”¶å…¥</strong>ï¼šåœ¨åˆ—è¡¨ä¸­ç‚¹â€œä¿®æ”¹â€<br>
           â€¢ <strong>åˆ é™¤æ”¶å…¥</strong>ï¼šåœ¨å¡ç‰‡ä¸Šç‚¹â€œåˆ é™¤â€<br><br>
           ä½ æƒ³å…ˆåšå“ªä¸€ä¸ªï¼Ÿ`
        );
        return;
      }

      // é—®å€™
      if (lower.includes('ä½ å¥½') || lower.includes('hi') || lower.includes('hello')) {
        showAIMessage(
          `ä½ å¥½ï¼<br><br>
           æˆ‘æ˜¯ä½ çš„æ”¶å…¥ç®¡ç†åŠ©æ‰‹ï¼Œå¯ä»¥å¸®ä½ ï¼š<br>
           â€¢ æŸ¥çœ‹æ”¶å…¥æ˜ç»†<br>
           â€¢ æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤æ”¶å…¥<br>
           â€¢ å›ç­”æ”¶å…¥ç›¸å…³é—®é¢˜<br><br>
           ä½ æƒ³å…ˆçœ‹â€œæ€»æ”¶å…¥â€è¿˜æ˜¯â€œå›ºå®šæ”¶å…¥â€ï¼Ÿ`
        );
        return;
      }

      // é»˜è®¤
      showAIMessage(
        `æˆ‘æ”¶åˆ°äº†ä½ çš„æ¶ˆæ¯ï¼šâ€œ${escapeHtml(message)}â€<br><br>
         ä½ å¯ä»¥è¯•è¯•é—®ï¼š<br>
         â€¢ æ”¶å…¥å¤šå°‘<br>
         â€¢ å›ºå®šæ”¶å…¥<br>
         â€¢ å…¶ä»–æ”¶å…¥<br>
         â€¢ ç»“ä½™`
      );
    }
  </script>
</body>
</html>
